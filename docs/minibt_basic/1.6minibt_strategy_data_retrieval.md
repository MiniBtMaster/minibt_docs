# **minibt量化交易：策略获取数据使用指南**

## 概述

&emsp;&emsp;`get_kline()` 方法是 minibt 量化回测库中 Strategy 类的核心方法，用于获取 K 线数据。它提供了统一的数据访问接口，支持多种数据源和格式，包括本地 CSV 文件、DataFrame 对象、TQSDK 期货数据、PyTDX 股票数据以及 SQLite 数据库。

## 基本语法

```python
def get_kline(self, symbol: str | pd.DataFrame = None, 
             duration_seconds: int = 60, 
             data_length: int | None = None, 
             **kwargs) -> KLine:
```

## 参数说明

- `symbol`: 数据标识，可以是字符串（合约代码/股票代码）或 pandas.DataFrame
- `duration_seconds`: K 线周期（秒），默认 60（1 分钟）
- `data_length`: 数据长度，默认 None（取数据源最大长度）
- `**kwargs`: 额外参数，包括：
  - `save`: 是否保存数据到本地 CSV
  - `user_name/password`: TQSDK 账号密码
  - `ip/port`: PyTDX 服务器 IP 和端口

## 使用示例

### 1. 从全局变量获取数据（auto=True）

```python
from minibt import *

# 创建全局 DataFrame
df = LocalDatas.test.dataframe

class MyStrategy(Strategy):
    def __init__(self):
        # 参数为 str 类型
        # auto=True，系统自动通过变量名读取全局 DataFrame
        self.data = self.get_kline("df")

if __name__ == "__main__":
    bt = Bt(auto=True)
    bt.run()
```

### 2. 从手动添加的数据获取（auto=False）

```python
from minibt import *

# 创建 DataFrame
df = LocalDatas.test.dataframe

class MyStrategy(Strategy):
    def __init__(self):
        # 参数为 str 类型
        # auto=False，系统读取通过 adddata() 添加的数据
        self.data = self.get_kline("df")

if __name__ == "__main__":
    bt = Bt()
    bt.adddata(df=df)  # 手动添加数据
    bt.run()
```

### 3. 使用 LocalDatas 类获取数据

```python
from minibt import *

class MyStrategy(Strategy):
    def __init__(self):
        # 使用 LocalDatas 类直接获取数据
        self.data = self.get_kline(LocalDatas.test)
        # 或直接调用本地kline
        self.data = LocalDatas.test.kline
```

### 4. 从文件路径获取数据

```python
from minibt import *

class MyStrategy(Strategy):
    def __init__(self):
        # 通过文件路径获取数据
        self.data = self.get_kline("./test.csv")

if __name__ == "__main__":
    bt = Bt(auto=True)
    bt.run()
```

### 5. 直接传入 DataFrame 对象

```python
from minibt import *

class MyStrategy(Strategy):
    def __init__(self):
        # 直接传入 DataFrame 对象
        self.data = self.get_kline(LocalDatas.test.dataframe)

if __name__ == "__main__":
    bt = Bt(auto=True)
    bt.run()
```

### 6. 获取期货数据（TQSDK）

```python
from minibt import *

class MyStrategy(Strategy):
    def __init__(self):
        # 获取期货数据（需要配置天勤账号）
        self.data = self.get_kline('SHFE.rb2410', 
                                 user_name="天勤账号", 
                                 password="天勤密码")

if __name__ == "__main__":
    bt = Bt()
    bt.run()
```

### 7. 获取股票数据（PyTDX）

```python
from minibt import *

class MyStrategy(Strategy):
    def __init__(self):
        # 获取股票数据（需要安装 pytdx）
        self.data = self.get_kline('600000')

if __name__ == "__main__":
    bt = Bt()
    bt.run()
```


### 8. 实盘模式获取数据

```python
from minibt import *

class MyStrategy(Strategy):
    def __init__(self):
        # 实盘模式下获取实时数据
        self.data = self.get_kline('SHFE.rb2410')

if __name__ == "__main__":
    bt = Bt()
    # 配置实盘连接
    bt.addTqapi(tq_auth, tq_account, live=True)
    bt.run()
```

### 9. 自定义 K 线周期和数据长度

```python
from minibt import *

class MyStrategy(Strategy):
    def __init__(self):
        # 获取 5 分钟 K 线，最多 1000 根
        self.data = self.get_kline('SHFE.rb2410', 60*5,
                                 data_length=1000)

if __name__ == "__main__":
    bt = Bt()
    bt.run()
```

### 10. 保存数据到本地

```python
from minibt import *

class MyStrategy(Strategy):
    def __init__(self):
        # 获取数据并保存到本地
        self.data = self.get_kline('SHFE.rb2410', 
                                 save="rb2410_data")

if __name__ == "__main__":
    bt = Bt()
    bt.run()
```

### 11. 实时行情

```python
from minibt import *
from tqsdk import TqApi, TqAuth, TqKq

class MyStrategy(Strategy):
    def __init__(self):
        self.data = self.get_kline('DCE.v2509', data_length=300)
        self.ebsw = self.data.close.ebsw()

if __name__ == "__main__":
    api = TqApi(TqKq(), auth=TqAuth(
        "账户", "密码"))
    bt = Bt()
    bt.run()
```

## 返回值

`get_kline()` 方法返回一个 `KLine` 对象，该对象封装了 K 线数据并提供了以下功能：

1. **数据访问**：通过属性访问开盘价、最高价、最低价、收盘价、成交量等
2. **技术指标**：内置多种技术指标计算方法（如 SMA、EMA、MACD 等）
3. **信号生成**：支持交叉信号、突破信号等常见交易信号生成
4. **数据操作**：支持数据切片、合并、重采样等操作

## 注意事项

1. **数据格式要求**：无论使用哪种数据源，数据必须包含以下字段：
   - `datetime`：时间戳
   - `open`：开盘价
   - `high`：最高价
   - `low`：最低价
   - `close`：收盘价
   - `volume`：成交量

2. **实盘数据获取**：获取实盘数据需要先配置天勤 API 连接

3. **股票数据获取**：获取股票数据需要安装 `pytdx` 库

4. **数据保存**：使用 `save` 参数保存数据时，会自动更新本地数据工具类

5. **性能考虑**：获取大量数据时，建议适当设置 `data_length` 参数以限制数据量

## 总结

&emsp;&emsp;`get_kline()` 方法是 minibt 库中非常强大和灵活的数据获取工具，支持多种数据源和格式，可以满足不同场景下的数据需求。通过合理使用各种参数，可以轻松获取回测或实盘所需的 K 线数据。

> 风险提示：本文涉及的交易策略、代码示例均为技术演示、教学探讨，仅用于展示逻辑思路，绝不构成任何投资建议、操作指引或决策依据 。金融市场复杂多变，存在价格波动、政策调整、流动性等多重风险，历史表现不预示未来结果。任何交易决策均需您自主判断、独立承担责任 —— 若依据本文内容操作，盈亏后果概由自身承担。请务必充分评估风险承受能力，理性对待市场，谨慎做出投资选择。