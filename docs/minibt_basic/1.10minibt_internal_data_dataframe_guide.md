# **minibt量化回测：内部数据 IndFrame 类完整指南**

## 概述

`IndFrame` 类是 minibt 量化框架中的核心数据容器类，它继承自 `pd.DataFrame`、`IndicatorsBase`、`PandasTa` 和 `TaLib`，是一个功能强大的多列指标数据格式。该类不仅保留了原生 pandas.DataFrame 的所有数据操作能力，还增加了指标计算、可视化配置、交易信号管理等量化交易专用功能。

## 核心特性

### 1. 多父类融合设计
- **继承 `pd.DataFrame`**：保留所有原生 DataFrame 的数据存储与计算能力
- **继承 `IndicatorsBase`**：获得指标基础属性与方法（ID管理、运算重载等）
- **继承 `PandasTa`/`TaLib`**：直接调用第三方指标库的计算接口

### 2. 自动化指标封装
- 每列数据自动封装为 `Line` 类型（框架内置单指标序列）
- 自动管理指标元数据（绘图配置、指标设置）
- 支持动态添加交易信号列

### 3. 交易信号原生支持
- 内置四种交易信号类型：多头开仓、多头离场、空头开仓、空头离场
- 支持信号样式自定义（颜色、标记、大小等）
- 信号自动关联绘图逻辑

### 4. 可视化深度集成
- 支持线型和信号样式的批量/单独设置
- 自动适配框架绘图模块，无需手动传递参数
- 支持多种图表类型（蜡烛图、折线图、柱状图等）

### 5. 数据兼容性强
- 支持多种输入数据类型（DataFrame、ndarray、列表、元组、字典）
- 提供灵活的数据转换方法（to_lines、to_ndarray）

## 初始化参数详解

### 数据输入参数
```python
# 从DataFrame创建
df = IndFrame(pd.DataFrame({"close": [1, 2, 3], "volume": [100, 200, 300]}))

# 从numpy数组创建（需指定列名）
arr = np.array([[1, 100], [2, 200], [3, 300]])
df = IndFrame(arr, lines=["close", "volume"])

# 从维度创建全NaN数组（自动标记为自定义数据）
df = IndFrame((100, 3))  # 100行3列的全NaN数组

# 从字典创建
df = IndFrame({"close": [1, 2, 3], "volume": [100, 200, 300]})
```

### 核心配置参数
```python
df = IndFrame(data, 
               lines=["close", "volume"],      # 列名列表
               id=BtID(),                      # 指标唯一标识
               isplot=True,                    # 是否绘图
               category="overlap",             # 指标分类
               overlap=False,                  # 是否主图叠加
               isha=False,                     # 是否为Heikin-Ashi蜡烛图
               islr=False,                     # 是否为线性回归指标
               ismain=False,                   # 是否为主图指标
               isindicator=True,               # 是否为技术指标
               iscustom=False,                 # 是否为自定义数据
               height=150,                     # 绘图高度
               sname="my_IndFrame",            # 策略内名称，创建策略时自动赋值
               ind_name="Custom Indicator")    # 指标类型名称
```

## 核心属性详解

### 1. 数据与指标基础属性
```python
# 绘图配置信息
plot_info = df._plotinfo

# 指标元数据设置
ind_setting = df._indsetting

# 数据集管理
dataset = df._dataset
```

### 2. 交易信号属性
```python
# 设置交易信号
df.long_signal = [0, 1, 0, 1]        # 多头开仓信号
df.exitlong_signal = [0, 0, 1, 0]    # 多头离场信号
df.short_signal = [1, 0, 0, 0]       # 空头开仓信号
df.exitshort_signal = [0, 0, 0, 1]   # 空头离场信号

# 获取交易信号
long_signal = df.long_signal
exitlong_signal = df.exitlong_signal
```

### 3. 样式配置属性
```python
# 信号样式设置
df.signal_style.long_signal = SignalStyle("low", Colors.blue, Markers.circle_dot, size=25)

# 线型设置
df.line_style = LineStyle(LineDash.dashdot, 3, Colors.red)

# 单独设置属性
df.signal_key.long_signal = "low"        # 信号位置
df.signal_color.long_signal = Colors.blue # 信号颜色
df.signal_size.long_signal = 25          # 信号大小
df.line_dash = LineDash.dashdot          # 线型虚实
df.line_width = 3                        # 线宽
df.line_color = Colors.red               # 线颜色
```

## 核心方法详解

### 1. assign - 扩展列
```python
# 添加新列
new_df = df.assign(
    new_column=df.close * 2,  # 新列计算
    keep=True                 # 保留原数据
)
```

### 2. to_lines - 转换为Line序列
```python
# 转换为Line序列
close_line, volume_line = df.to_lines("close", "volume")

# 转换为所有列的Line序列
all_lines = df.to_lines()
```

### 3. to_ndarray - 转换为numpy数组
```python
# 转换为numpy数组
close_arr, volume_arr = df.to_ndarray()
```

## 使用示例

### 基本数据操作
```python
# 创建IndFrame
data = pd.DataFrame({
    "close": [100, 101, 102, 103, 104],
    "volume": [1000, 1200, 800, 1500, 900]
})
df = IndFrame(data, category="price")

# 访问列数据（返回Line对象）
close_line = df.close
volume_line = df.volume

# 基本运算
price_change = df.close - df.close.shift(1)
volume_ratio = df.volume / df.volume.mean()

# 条件筛选
high_volume = df[df.volume > 1000]
```

### 交易信号生成与管理
```python
# 生成交易信号
rsi = df.close.pta.rsi(length=14)  # 计算RSI
df.long_signal = (rsi < 30) & (df.close > df.close.rolling(20).mean())  # 超卖且价格在均线上方
df.exitlong_signal = (rsi > 70) | (df.close < df.close.rolling(20).mean())  # 超买或价格跌破均线

# 设置信号样式
df.signal_style.long_signal = SignalStyle(
    "low", Colors.green, Markers.triangle_up, size=20
)
df.signal_style.exitlong_signal = SignalStyle(
    "high", Colors.red, Markers.triangle_down, size=20
)
```

### 技术指标计算
```python
# 使用PandasTA指标
sma = df.close.pta.sma(length=20)
ema = df.close.pta.ema(length=10)
macd = df.close.pta.macd()

# 使用TA-Lib指标
rsi = df.close.talib.RSI(timeperiod=14)
stoch = df.close.talib.STOCH()

# 使用内置指标
super_trend = df.close.btind.supertrend(period=10, multiplier=3)
```

### 数据可视化配置
```python
# 设置绘图样式
df.line_style.close = LineStyle(LineDash.solid, 2, Colors.blue)
df.line_style.volume = LineStyle(LineDash.dotted, 1, Colors.gray)

# 设置信号样式
df.signal_style.long_signal = SignalStyle(
    "low", Colors.green, Markers.circle, size=15
)

```

### 多周期数据处理
```python
# 上采样到更高周期
daily_df = df.resample(60*5)  # 转换为5分钟周期
```

## 高级用法

### 自定义指标计算
```python
# 使用apply方法计算自定义指标
def custom_indicator(close, volume):
    return close * 0.7 + volume * 0.0003

df['custom_ind'] = df.apply(
    lambda row: custom_indicator(row['close'], row['volume']), 
    axis=1
)

# 使用rolling_apply计算滚动自定义指标
def rolling_custom(window):
    return (window[-1] - window[0]) / window[0]

df['rolling_custom'] = df.close.rolling_apply(rolling_custom, window=10)
```

### 多数据源合并
```python
# 合并多个IndFrame
df1 = IndFrame({"close": [1, 2, 3], "volume": [100, 200, 300]})
df2 = IndFrame({"open": [1, 2, 3], "high": [2, 3, 4]})

# 按IndFrame合并
merged_df = df1.assign(df2)

# 按列合并
merged_df = df1.assign(ma10=df1.close.sma(10))

```
### 支持所有pd.DataFrame方法运算


### 策略集成
```python
# 在策略中使用IndFrame
from minibt import *


class MyStrategy(Strategy):
    def __init__(self):
        self.data = LocalDatas.v2601_300.kline
        self.indicators = IndFrame({
            "ma5": self.data.close.pta.sma(5),
            "ma20": self.data.close.pta.sma(20),
            "rsi": self.data.close.pta.rsi(14)
        })

        # 生成交易信号
        self.indicators.long_signal = (
            (self.indicators.ma5 > self.indicators.ma20) &
            (self.indicators.rsi < 70)
        )
        self.indicators.short_signal = (
            (self.indicators.ma5 > self.indicators.ma20) &
            (self.indicators.rsi > 30)
        )

    def next(self):
        if not self.data.position:
            if self.indicators.long_signal.new:
                self.data.buy()
        elif self.indicators.short_signal.new:
            self.data.sell()


if __name__ == "__main__":
    Bt().run()

```

## 总结

minibt 的 `IndFrame` 类是一个功能强大的多列指标数据容器，它：

1. **融合多种数据类型**：结合了 pandas.DataFrame 的数据操作能力和量化交易专用功能
2. **自动化指标管理**：自动将每列数据封装为 Line 对象，支持完整的指标生态系统
3. **原生交易信号支持**：内置四种交易信号类型，支持灵活的样式配置
4. **深度可视化集成**：提供丰富的绘图配置选项，自动适配框架绘图模块
5. **强大的扩展能力**：支持多种数据输入格式，提供灵活的数据转换方法

&emsp;&emsp;通过 `IndFrame` 类，开发者可以以一致的方式处理多列指标数据，大大简化了复杂策略的实现难度，提高了代码的可读性和可维护性。无论是简单的技术指标计算还是复杂的多因子策略，`IndFrame` 都能提供强大的支持。

> 风险提示：本文涉及的交易策略、代码示例均为技术演示、教学探讨，仅用于展示逻辑思路，绝不构成任何投资建议、操作指引或决策依据 。金融市场复杂多变，存在价格波动、政策调整、流动性等多重风险，历史表现不预示未来结果。任何交易决策均需您自主判断、独立承担责任 —— 若依据本文内容操作，盈亏后果概由自身承担。请务必充分评估风险承受能力，理性对待市场，谨慎做出投资选择。