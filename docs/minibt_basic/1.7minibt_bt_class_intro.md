# **minibt量化交易：Bt类介绍**

## 概述

&emsp;&emsp;Bt 类是 minibt 量化回测与实盘框架的核心引擎，类似于 backtrader 中的 Cerebro。它负责协调整个回测/实盘流程，包括数据加载、策略管理、参数优化、执行引擎和结果分析。

## 主要功能

### 1. 数据管理
- **自动数据发现**：通过 `auto=True` 参数自动查找全局 DataFrame 数据
- **手动数据添加**：使用 `adddata()` 方法手动添加 pandas.DataFrame 格式数据
- **数据验证**：确保数据包含必要的字段（datetime, open, high, low, close, volume）

### 2. 策略管理
- **策略加载**：支持通过 `addstrategy()` 添加自定义策略
- **多策略支持**：可同时运行多个策略并进行比较
- **默认策略**：当未指定策略时自动加载默认策略

### 3. 实盘交易对接
- **天勤API集成**：通过 `addTqapi()` 连接天勤实盘/模拟盘
- **实时数据推送**：支持实盘行情数据的实时接收和处理
- **交易执行**：自动处理实盘交易订单和执行

### 4. 参数优化
- **多目标优化**：支持同时优化多个性能指标（收益、胜率、夏普率等）
- **优化算法**：提供遗传算法(GA)和贝叶斯优化(Optuna)两种优化方法
- **参数空间定义**：灵活的参数范围定义方式（范围、列表、固定值）

### 5. 回测执行
- **单策略回测**：基础的单策略回测功能
- **多策略并行**：支持多策略并行回测，提高效率
- **强化学习支持**：集成强化学习策略回测功能

### 6. 结果分析
- **可视化图表**：使用 Bokeh 生成交互式图表
- **QuantStats 报告**：生成详细的量化性能分析报告
- **多种输出格式**：支持控制台报告、HTML报告、Jupyter交互式显示

## 核心方法

### 初始化方法
```python
def __init__(self, auto=True, live=False, replay=False, **kwargs) -> None:
```
- `auto`: 是否自动加载全局资源（推荐生产环境手动添加，调试时可开启）
- `live`: 是否启用实盘模式（默认False，即回测模式）
- `replay`: 是否启用回放模式（用于策略回放测试，默认False）
  
**kwargs: 额外配置参数**
- `quick_live`: 快速实盘配置

### 数据添加方法
```python
def adddata(self, *args, **kwargs: dict[str, pd.DataFrame]) -> Bt:
```
添加回测数据，支持多个 DataFrame

### 策略添加方法
```python
def addstrategy(self, *args: Strategy, **kwargs: list[dict] | dict) -> Bt
```
添加策略类，支持多策略和参数传递

### 实盘连接方法
```python
def addTqapi(self, tq_auth: tq_auth, tq_account: tq_account | None = None, live: bool = False) -> None
```
连接天勤实盘/模拟盘 API

### 参数优化配置
```python
def optstrategy(self, target: Literal['result', 'profit', ...] = 'profit_ratio',
                weights: float | tuple[float] = 1., 
                opconfig: OpConfig | OptunaConfig | dict | list[dict] = {}, 
                op_method: Literal['ga', 'optuna'] = 'optuna', 
                show_bar=True, skip=False, **kwargs)
```
配置策略参数优化，支持多目标和多种优化算法

### 执行方法
```python
def run(self, isplot=True, isreport: bool = False, **kwargs) -> Bt
```
执行回测或实盘交易，支持图表生成和报告输出

### 结果分析方法
```python
def bokeh_plot(self, trade_signal: bool = True, ...)  # 生成交互式图表
def qs_reports(self, select: int | str | list[int] = 'all', **kwargs)  # 生成分析报告
def get_results(self, select: int | str | list[int] = 'all')  # 获取回测数据
def qs_stats(self, select: int = 0) -> Stats  # 获取统计对象
def qs_plot(self, select: int = 0) -> QSPlots  # 获取可视化对象
```

## 使用流程

1. **初始化 Bt 实例**
   ```python
   bt = Bt(auto=True)
   ```

2. **添加数据和策略**（如果未使用 auto=True）
   ```python
   bt.adddata(df=dataframe).addstrategy(MyStrategy)
   ```

3. **（可选）配置参数优化**
   ```python
   bt.optstrategy(["profit", "win_rate"], (1, 1), 
                  length1=(5, 15, 1), length2=(20, 30, 1))
   ```

4. **执行回测/实盘**
   ```python
   bt.run(isplot=True, isreport=True)
   ```

5. **分析结果**
   ```python
   bt.bokeh_plot()  # 查看图表
   bt.qs_reports()  # 查看报告
   ```

## 特性亮点

1. **轻量级设计**：相比 backtrader，minibt 更加轻量简洁
2. **多策略并行**：原生支持多策略并行回测，大幅提高效率
3. **实盘集成**：深度集成天勤API，回测与实盘代码无缝切换
4. **灵活的参数优化**：支持多种优化算法和多目标优化
5. **丰富的可视化**：基于 Bokeh 和 QuantStats 提供专业级的可视化效果
6. **强化学习支持**：内置强化学习策略回测框架

## 与 backtrader 的对比

| 特性     | minibt Bt        | backtrader Cerebro |
| -------- | ---------------- | ------------------ |
| 设计理念 | 轻量级、易用     | 功能全面、复杂     |
| 并行支持 | 原生多策略并行   | 有限并行支持       |
| 实盘集成 | 深度集成天勤API  | 需要额外扩展       |
| 参数优化 | 多算法多目标优化 | 基础优化功能       |
| 可视化   | Bokeh交互式图表  | 基础matplotlib图表 |
| 学习曲线 | 较低             | 较高               |

&emsp;&emsp;Bt 类作为 minibt 框架的核心，提供了一个现代化、功能丰富的量化回测和实盘交易平台，特别适合需要快速迭代策略、进行参数优化和实盘交易的开发者使用。

> 风险提示：本文涉及的交易策略、代码示例均为技术演示、教学探讨，仅用于展示逻辑思路，绝不构成任何投资建议、操作指引或决策依据 。金融市场复杂多变，存在价格波动、政策调整、流动性等多重风险，历史表现不预示未来结果。任何交易决策均需您自主判断、独立承担责任 —— 若依据本文内容操作，盈亏后果概由自身承担。请务必充分评估风险承受能力，理性对待市场，谨慎做出投资选择。