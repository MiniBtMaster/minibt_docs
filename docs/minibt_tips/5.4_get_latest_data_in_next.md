# minibt 使用技巧：next函数中获取最新数据
在 minibt 的 `Strategy` 类中，`next` 函数是逐根处理 K 线的核心入口，获取当前/历史 K 线数据/指标值有**三种等效方式**，掌握这些技巧能大幅提升策略编写效率。

## 一、核心获取方式（三类方法）
### 1. 基础：负数索引（最直观）
直接通过 `[-n]` 索引访问，`-1` 代表**最新一根 K 线**，`-2` 代表**上一根**，以此类推，是 minibt 最基础也最常用的方式。
```python
# 格式：self.数据/指标[-n]
self.data.close[-1]  # 最新收盘价
self.data.high[-2]   # 上一根K线最高价
self.ma5[-3]         # 倒数第三根K线对应的5日均线值
```

### 2. 规范：iloc 负数索引（兼容 pandas 习惯）
minibt 的数据/指标对象兼容 pandas 语法，可通过 `iloc[-n]` 访问，效果与直接负数索引完全一致，适合习惯 pandas 操作的开发者。
```python
# 格式：self.数据/指标.iloc[-n]
self.data.close.iloc[-1]  # 最新收盘价（等同于self.data.close[-1]）
self.data.volume.iloc[-2] # 上一根K线成交量
self.ma20.iloc[-5]        # 倒数第五根K线对应的20日均线值
```

### 3. 便捷：内置属性（最简洁，推荐）
minibt 封装了常用的「最新/上一根/上两根」数据属性，无需记索引数字，代码可读性更高：
| 便捷属性   | 等效索引          | 含义                      |
| ---------- | ----------------- | ------------------------- |
| `new`      | `[-1]`/`iloc[-1]` | 最新一根K线对应值         |
| `prev`     | `[-2]`/`iloc[-2]` | 上一根K线对应值           |
| `sndprev`  | `[-3]`/`iloc[-3]` | 上两根K线对应值（第二前） |
| `trdprev`  | `[-4]`/`iloc[-4]` | 上三根K线对应值（第三前） |
| `frthprev` | `[-5]`/`iloc[-5]` | 上四根K线对应值（第四前） |
> 注：`sndprev` 是 `second previous` 的缩写，仅支持到倒数第五根，倒数第六及以后仍需用 `[-6]`/`iloc[-6]`。

## 二、完整示例（实战场景）
下面通过一个双均线策略示例，展示三种方式的实际应用：
```python
from minibt import *

class MyDoubleMAStrategy(Strategy):
    def __init__(self):
        # 1. 绑定数据源（以沪深300为例）
        self.data = LocalDatas.v2601_300.kline
        
        # 2. 计算均线指标
        self.ma5 = self.data.close.sma(5)   # 5日均线
        self.ma20 = self.data.close.sma(20) # 20日均线
        
        # 3. 计算交叉信号
        self.gold_cross = self.ma5.cross_up(self.ma20)  # 金叉（上穿）
        self.death_cross = self.ma5.cross_down(self.ma20)  # 死叉（下穿）

    def next(self):
        """next函数：逐根处理K线，核心逻辑写在这里"""
        # ===================== 方式1：负数索引（直观） =====================
        # 最新数据
        latest_close = self.data.close[-1]
        latest_ma5 = self.ma5[-1]
        latest_gold = self.gold_cross[-1]  # 最新是否金叉
        
        # 上一根数据
        prev_close = self.data.close[-2]
        prev_ma20 = self.ma20[-2]
        
        # 倒数第三根数据
        sndprev_close = self.data.close[-3]

        # ===================== 方式2：iloc负数索引（pandas风格） =====================
        latest_close_iloc = self.data.close.iloc[-1]
        prev_ma5_iloc = self.ma5.iloc[-2]
        sndprev_ma20_iloc = self.ma20.iloc[-3]

        # ===================== 方式3：便捷属性（最简洁，推荐） =====================
        latest_close_attr = self.data.close.new
        prev_close_attr = self.data.close.prev
        sndprev_close_attr = self.data.close.sndprev  # 倒数第三根
        
        latest_ma5_attr = self.ma5.new
        prev_ma20_attr = self.ma20.prev
        latest_death = self.death_cross.new  # 最新是否死叉

        # ===================== 实战：交易信号判断 =====================
        # 金叉买入（三种方式任选其一，效果一致）
        if self.gold_cross.new:  # 等同于self.gold_cross[-1] / self.gold_cross.iloc[-1]
            self.data.buy()
            print(f"买入信号：{self.data.datetime.new} | 收盘价：{self.data.close.new}")
        
        # 死叉卖出
        if self.death_cross.new:
            self.data.sell()
            print(f"卖出信号：{self.data.datetime.new} | 收盘价：{self.data.close.new}")

# 运行策略
if __name__ == "__main__":
    Bt().run()
```

## 三、使用建议（避坑+最佳实践）
1. **优先用便捷属性**：`new/prev/sndprev/trdprev/frthprev` 代码最简洁，可读性最高，适合获取最新/上1/上2/上3/上4根数据；
2. **负数索引适配场景**：需要获取「倒数第n根（n>5）」数据时，直接用 `[-n]`（如 `[-6]` 取倒数第六根），无需拼接属性；
3. **iloc 兼容场景**：如果策略中需要混合 pandas 操作（如切片、筛选），用 `iloc[-n]` 风格更统一；
4. **注意数据长度**：获取 `[-n]` 数据时，需确保策略已加载至少 n 根 K 线（可通过 `self.min_start_length = n` 设定最小启动K线数），避免索引越界；
5. **指标与K线通用**：以上三种方式对「原始K线数据（close/high/volume）」和「自定义指标（MA/RSI/交叉信号）」完全通用。

## 四、核心总结
| 获取目标           | 负数索引              | iloc索引                   | 便捷属性                   |
| ------------------ | --------------------- | -------------------------- | -------------------------- |
| 最新数据           | `self.data.close[-1]` | `self.data.close.iloc[-1]` | `self.data.close.new`      |
| 上一根数据         | `self.data.close[-2]` | `self.data.close.iloc[-2]` | `self.data.close.prev`     |
| 倒数第三根数据     | `self.data.close[-3]` | `self.data.close.iloc[-3]` | `self.data.close.sndprev`  |
| 倒数第四根数据     | `self.data.close[-4]` | `self.data.close.iloc[-4]` | `self.data.close.trdprev`  |
| 倒数第五根数据     | `self.data.close[-5]` | `self.data.close.iloc[-5]` | `self.data.close.frthprev` |
| 倒数第n根数据(n>5) | `self.data.close[-n]` | `self.data.close.iloc[-n]` | 无（推荐用负数索引）       |

掌握这三类获取方式，能灵活应对 minibt 策略中「实时判断信号、回溯历史数据、计算指标差值」等核心场景，大幅提升策略编写效率和可读性。